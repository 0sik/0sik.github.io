ğŸ“˜ìŠ¤í”„ë§ë¶€íŠ¸

# Repositoryê°œë°œ
> @Repository : ìŠ¤í”„ë§ ë¹ˆìœ¼ë¡œ ë“±ë¡, JPA ì˜ˆì™¸ë¥¼ ìŠ¤í”„ë§ ê¸°ë°˜ ì˜ˆì™¸ë¡œ ì˜ˆì™¸ ë³€í™˜
@PersistenceContext : ì—”í‹°í‹° ë©”ë‹ˆì €( EntityManager ) ì£¼ì…
@PersistenceUnit : ì—”í‹°í‹° ë©”ë‹ˆí„° íŒ©í† ë¦¬( EntityManagerFactory ) ì£¼ì…//ê±°ì˜ ì•ˆì”€ PersistenceContextê°€ ìˆì–´ì„œ

```

@Repository
public class MemberRepository {

    @PersistenceContext // ì—”í‹°í‹° ë©”ë‹ˆì € ì£¼ì…
    private EntityManager em;

    public  void save(Member member){
        em.persist(member);
    }

    public Member findOne(Long id){
        return em.find(Member.class,id);
    }

    public List<Member> findAll(){ //jpqlë¬¸ë²•ì„ ì‚¬ìš©í•˜ì—¬ ê²€ìƒ‰
        return em.createQuery("select m from Member m ",Member.class)
                .getResultList();
    }

    public List<Member> findbyName(String name){ //jpqlë¬¸ë²•ì„ ì‚¬ìš©í•˜ì—¬ ê²€ìƒ‰
        return em.createQuery("select m from Member m.name = :name", Member.class)
                .setParameter("name",name)
                .getResultList();
    }
}

```

# service ê°œë°œ
> ìƒì„±ì ì£¼ì… ë°©ì‹ì„ ê¶Œì¥
ë³€ê²½ ë¶ˆê°€ëŠ¥í•œ ì•ˆì „í•œ ê°ì²´ ìƒì„± ê°€ëŠ¥
ìƒì„±ìê°€ í•˜ë‚˜ë©´, @Autowired ë¥¼ ìƒëµí•  ìˆ˜ ìˆë‹¤.
@RequiredArgsConstructor ì„ ì‚¬ìš©í•˜ë©´ Autowiredìƒëµí• ìˆ˜ìˆê³ , final í‚¤ì›Œë“œë¥¼ ì¶”ê°€í•˜ë©´ ì»´íŒŒì¼ ì‹œì ì— memberRepository ë¥¼ ì„¤ì •í•˜ì§€ ì•ŠëŠ” ì˜¤ë¥˜ë¥¼ ì²´í¬í•  ìˆ˜ ìˆë‹¤.
(ë³´í†µ ê¸°ë³¸ ìƒì„±ìë¥¼ ì¶”ê°€í•  ë•Œ ë°œê²¬)
@Transactional : íŠ¸ëœì­ì…˜, ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸,ë°ì´í„°ë² ì´ìŠ¤ì˜ ìƒíƒœë¥¼ ë³€í™”ì‹œí‚¤ê¸° í•´ì„œ ìˆ˜í–‰í•˜ëŠ” ì‘ì—…ì˜ ë‹¨ìœ„ë¥¼ ëœ»í•œë‹¤.
readOnly=true : ë°ì´í„°ì˜ ë³€ê²½ì´ ì—†ëŠ” ì½ê¸° ì „ìš© ë©”ì„œë“œì— ì‚¬ìš©, ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ í”ŒëŸ¬ì‹œ í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ì•½ê°„ì˜ ì„±ëŠ¥ í–¥ìƒ(ì½ê¸° ì „ìš©ì—ëŠ” ë‹¤ ì ìš©)
ë°ì´í„°ë² ì´ìŠ¤ ë“œë¼ì´ë²„ê°€ ì§€ì›í•˜ë©´ DBì—ì„œ ì„±ëŠ¥ í–¥ìƒ



```
@Service
@Transactional(readOnly = true) //ë°ì´í„° ë² ì´ìŠ¤ ìƒíƒœ ë³€í™”
@RequiredArgsConstructor //Autowiredë¥¼ ìƒëµí•˜ê³  final í‚¤ì›Œë“œ ì¶”ê°€
public class MemberService {


    private final MemberRepository memberRepository;

    //íšŒì› ê°€ì…
    @Transactional
    public Long join(Member member){
        validateDuplicateMember(member);//ì¤‘ë³µ íšŒì› ê²€ì¦
        memberRepository.save(member);
        return member.getId();
    }

    private void validateDuplicateMember(Member member) {
        List<Member> findMembers = memberRepository.findbyName(member.getName());
        if(!findMembers.isEmpty()){
            throw new IllegalStateException("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” íšŒì›ì…ë‹ˆë‹¤.");
        }

    }
    //íšŒì› ì „ì²´ ì¡°íšŒ

    public List<Member> findMembers(){
        return memberRepository.findAll();
    }

    public Member findOne(Long memberId){
        return memberRepository.findOne(memberId);
    }
}

```
# testê°œë°œ
```
@RunWith(SpringRunner.class)
@SpringBootTest
@Transactional
public class MemberServiceTest {

    @Autowired MemberService memberService;
    @Autowired MemberRepository memberRepository;
    @Autowired EntityManager em; //ë°ì´í„°ë² ì´ìŠ¤ì— ë°˜ì˜í•˜ê¸°ìœ„í•´ ì”€
    @Test
    public void íšŒì›ê°€ì…() throws Exception{
        //given
        Member member = new Member();
        member.setName("kim");
        //when
        Long saveId = memberService.join(member);
        //then
         em.flush();//ë°ì´í„° ë² ì´ìŠ¤ì— ë°˜ì˜í• ìˆ˜ìˆë‹¤.
        assertEquals(member,memberRepository.findOne(saveId));
    }
    @Test(expected = IllegalStateException.class)
    public void ì¤‘ë³µ_íšŒì›_ì˜ˆì™¸() throws Exception{
        //given
        Member member1 = new Member();
        member1.setName("Kim");

        Member member2 = new Member();
        member2.setName("Kim");
        //when
        memberService.join(member1);
        memberService.join(member2);//ì˜ˆì™¸ê°€ ë°œìƒí•´ì•¼ í•œë‹¤!!

        //then
        fail("ì˜ˆì™¸ê°€ ë°œìƒí•´ì•¼ í•œë‹¤.");
    }

}
```
í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ë¥¼ ìœ„í•œ ì„¤ì •
í…ŒìŠ¤íŠ¸ëŠ” ì¼€ì´ìŠ¤ ê²©ë¦¬ëœ í™˜ê²½ì—ì„œ ì‹¤í–‰í•˜ê³ , ëë‚˜ë©´ ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ëŠ” ê²ƒì´ ì¢‹ë‹¤. ê·¸ëŸ° ë©´ì—ì„œ ë©”ëª¨ë¦¬
DBë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ê°€ì¥ ì´ìƒì ì´ë‹¤.
ì¶”ê°€ë¡œ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ë¥¼ ìœ„í•œ ìŠ¤í”„ë§ í™˜ê²½ê³¼, ì¼ë°˜ì ìœ¼ë¡œ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì‹¤í–‰í•˜ëŠ” í™˜ê²½ì€ ë³´í†µ ë‹¤ë¥´ë¯€ë¡œ
ì„¤ì • íŒŒì¼ì„ ë‹¤ë¥´ê²Œ ì‚¬ìš©í•˜ì.
ë‹¤ìŒê³¼ ê°™ì´ ê°„ë‹¨í•˜ê²Œ í…ŒìŠ¤íŠ¸ìš© ì„¤ì • íŒŒì¼ì„ ì¶”ê°€í•˜ë©´ ëœë‹¤.

> test/resources/application.yml

ì´ì œ í…ŒìŠ¤íŠ¸ì—ì„œ ìŠ¤í”„ë§ì„ ì‹¤í–‰í•˜ë©´ ì´ ìœ„ì¹˜ì— ìˆëŠ” ì„¤ì • íŒŒì¼ì„ ì½ëŠ”ë‹¤.
(ë§Œì•½ ì´ ìœ„ì¹˜ì— ì—†ìœ¼ë©´ src/resources/application.yml ì„ ì½ëŠ”ë‹¤.)
ìŠ¤í”„ë§ ë¶€íŠ¸ëŠ” datasource ì„¤ì •ì´ ì—†ìœ¼ë©´, ê¸°ë³¸ì ì„ ë©”ëª¨ë¦¬ DBë¥¼ ì‚¬ìš©í•˜ê³ , driver-classë„ í˜„ì¬ ë“±ë¡ëœ
ë¼ì´ë¸ŒëŸ¬ë¥¼ ë³´ê³  ì°¾ì•„ì¤€ë‹¤. ì¶”ê°€ë¡œ ddl-auto ë„ create-drop ëª¨ë“œë¡œ ë™ì‘í•œë‹¤. ë”°ë¼ì„œ ë°ì´í„°ì†ŒìŠ¤ë‚˜,
JPA ê´€ë ¨ëœ ë³„ë„ì˜ ì¶”ê°€ ì„¤ì •ì„ í•˜ì§€ ì•Šì•„ë„ ëœë‹¤.
